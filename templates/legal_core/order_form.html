{% load static %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة معالجة حُجَّة</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { background-color: #f1f5f9; font-family: 'Cairo', sans-serif; }

        /* هيدر الصفحة مع الشعار المركزي */
        .service-header {
            background: #0f172a; padding: 50px 0; color: white;
            text-align: center; border-bottom: 5px solid #c5a059;
        }
        .order-logo-mid {
            width: 280px;
            height: auto;
            margin-bottom: 20px;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.4));
        }

        .card-custom { border: none; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.05); }
        .ai-result-box {
            background: #f8fafc; border-right: 4px solid #c5a059;
            padding: 20px; border-radius: 10px; margin-top: 15px;
            border: 1px solid #e2e8f0;
        }
        .badge-status { padding: 8px 15px; border-radius: 8px; font-weight: 600; font-size: 0.85rem; }

        /* ألوان حالات الطلب */
        .status-pending_review { background-color: #6c757d !important; color: white; }
        .status-awaiting_deposit { background-color: #f59e0b !important; color: white; }
        .status-processing { background-color: #3b82f6 !important; color: white; }
        .status-supervisor_review { background-color: #8b5cf6 !important; color: white; }
        .status-completed { background-color: #10b981 !important; color: white; }

        .btn-gold { background: #c5a059; color: white; border: none; transition: 0.3s; }
        .btn-gold:hover { background: #a68546; color: white; transform: translateY(-2px); }
    </style>
</head>
<body>

<header class="service-header">
    <div class="container">
        <img src="{% static 'images/logo.png' %}" alt="حُجَّة" class="order-logo-mid">
        <h2 class="fw-bold">
            {% if service_type == 'audit' %} تدقيق وتطهير العقود
            {% elif service_type == 'engineer' %} هندسة وصياغة العقود
            {% else %} التحصين والحماية القضائية {% endif %}
        </h2>
        <p class="text-warning small"><i class="fas fa-user-circle me-1"></i> العميل المتصل: {{ request.user.username }}</p>
    </div>
</header>

<main class="container my-5">
    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card card-custom p-4 shadow-sm bg-white border-top border-4 border-dark">
                <h5 class="fw-bold mb-4 text-dark"><i class="fas fa-file-upload me-2 text-warning"></i> طلب معالجة جديد</h5>
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    {% for field in form %}
                    <div class="mb-3">
                        <label class="form-label fw-bold small text-secondary">{{ field.label }}</label>
                        {{ field }}
                    </div>
                    {% endfor %}
                    <button type="submit" class="btn btn-dark w-100 py-3 fw-bold mt-2 shadow">
                        إرسال الطلب للفحص <i class="fas fa-paper-plane ms-1"></i>
                    </button>
                </form>
                <div class="mt-4 p-3 bg-light rounded-3 small text-muted">
                    <i class="fas fa-info-circle me-1"></i> فور إرسال الطلب، سيقوم النظام بمراجعته وإرسال رابط سداد رسوم الجدية (10$) إلى بريدك الإلكتروني المسجل.
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <h5 class="fw-bold mb-4 text-dark d-flex justify-content-between align-items-center">
                <span><i class="fas fa-history me-2 text-warning"></i>سجل العمليات الخاصة بك</span>
                <a href="/" class="btn btn-sm btn-outline-dark px-3">الرئيسية</a>
            </h5>

            {% for req in requests %}
                <div class="card card-custom mb-4 overflow-hidden border">
                    <div class="card-header bg-white py-3 border-bottom">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold">طلب رقم #{{ req.id }}</span>
                            <span class="badge badge-status status-{{ req.status }}">
                                {{ req.get_status_display }}
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-6 small text-muted"><i class="fas fa-globe-africa me-1"></i> اختصاص: {{ req.country }}</div>
                            <div class="col-6 small text-muted text-end"><i class="fas fa-calendar-alt me-1"></i> {{ req.created_at|date:"Y-m-d" }}</div>
                        </div>

                        {% if req.status == 'pending_review' %}
                            <div class="alert alert-secondary py-3 mb-0 small">
                                <i class="fas fa-hourglass-start me-2"></i> استلمنا طلبك بنجاح. سنقوم بإرسال إشعار السداد إليك قريباً.
                            </div>
                        {% elif req.status == 'awaiting_deposit' %}
                            <div class="alert alert-warning py-3 mb-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="small"><i class="fas fa-exclamation-triangle me-2"></i> بانتظار سداد رسوم جدية الطلب (10 دولار).</span>
                                    <a href="#" class="btn btn-sm btn-dark">رابط السداد <i class="fas fa-external-link-alt ms-1"></i></a>
                                </div>
                            </div>
                        {% elif req.ai_report %}
                            <div class="ai-result-box shadow-sm">
                                <strong class="text-dark d-block mb-2"><i class="fas fa-robot me-1 text-primary"></i> مسودة التحليل الذكي (أولية):</strong>
                                <div class="text-dark small" style="line-height: 1.6;">
                                    {{ req.ai_report|truncatewords:50 }}...
                                    <span class="text-muted">(يتم الآن مراجعة هذه المسودة من قبل المشرف)</span>
                                </div>
                            </div>
                        {% endif %}

                        {% if req.status == 'completed' and req.final_document %}
                            <div class="mt-3 p-3 bg-success bg-opacity-10 rounded-3 border border-success border-opacity-25">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold text-success small">الوثيقة القانونية النهائية جاهزة للاستلام:</span>
                                    <a href="{{ req.final_document.url }}" class="btn btn-sm btn-gold shadow-sm px-4">
                                        تحميل الوثيقة <i class="fas fa-download ms-1"></i>
                                    </a>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% empty %}
                <div class="text-center py-5 bg-white rounded-4 shadow-sm border mt-2">
                    <i class="fas fa-folder-open fa-3x text-light mb-3"></i>
                    <p class="text-muted">لا يوجد لديك طلبات سابقة في هذا القسم حتى الآن.</p>
                </div>
            {% endfor %}
        </div>
    </div>
</main>

</body>
</html>